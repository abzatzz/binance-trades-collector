# Data Provider Environment Configuration - ClickHouse Architecture
# ================================================================
# Copy this file to .env and configure your actual values
# DO NOT commit .env files with real credentials to version control

# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Application environment: development, staging, production
ENVIRONMENT=development

# Enable debug mode (true/false)
DEBUG=false

# =============================================================================
# CLICKHOUSE CONFIGURATION (Primary Storage Backend)
# =============================================================================

# Connection settings
CLICKHOUSE_HOST=""
CLICKHOUSE_PORT=9000
CLICKHOUSE_HTTP_PORT=8123
CLICKHOUSE_DATABASE=
CLICKHOUSE_USERNAME=
CLICKHOUSE_PASSWORD=

# Connection pool settings
CLICKHOUSE_CONNECTION_POOL_SIZE=10
CLICKHOUSE_MAX_CONNECTIONS_PER_HOST=20
CLICKHOUSE_CONNECTION_TIMEOUT=60
CLICKHOUSE_QUERY_TIMEOUT=600

# Compression settings
CLICKHOUSE_ENABLE_COMPRESSION=true
CLICKHOUSE_COMPRESSION_METHOD=lz4
CLICKHOUSE_ENABLE_HTTP_COMPRESSION=true

# Buffer table settings (high-performance inserts)
CLICKHOUSE_BUFFER_ENABLED=false
CLICKHOUSE_BUFFER_NUM_LAYERS=16
CLICKHOUSE_BUFFER_MIN_TIME=10
CLICKHOUSE_BUFFER_MAX_TIME=100
CLICKHOUSE_BUFFER_MIN_ROWS=10000
CLICKHOUSE_BUFFER_MAX_ROWS=1000000
CLICKHOUSE_BUFFER_MIN_BYTES=10000000
CLICKHOUSE_BUFFER_MAX_BYTES=100000000

# Materialized Views settings
CLICKHOUSE_MATERIALIZED_VIEWS_ENABLED=true
CLICKHOUSE_DEFAULT_TIMEFRAMES_MINUTES=1,5,15,60,240,1440
CLICKHOUSE_MV_REFRESH_INTERVAL=5

# Data retention settings (TTL)
CLICKHOUSE_TRADES_RETENTION_DAYS=3650
CLICKHOUSE_ENABLE_AUTO_CLEANUP=false

# Partitioning strategy
CLICKHOUSE_PARTITION_BY_SYMBOL_HASH=true
CLICKHOUSE_SYMBOL_HASH_BUCKETS=16

# Performance optimization
CLICKHOUSE_MAX_INSERT_BLOCK_SIZE=1048576
CLICKHOUSE_MAX_THREADS=4
CLICKHOUSE_ENABLE_PARALLEL_REPLICAS=false

# Monitoring and health checks
CLICKHOUSE_HEALTH_CHECK_INTERVAL=60
CLICKHOUSE_SLOW_QUERY_THRESHOLD=10
CLICKHOUSE_ENABLE_QUERY_LOGGING=true

# Connection retry settings
CLICKHOUSE_MAX_RETRIES=2
CLICKHOUSE_RETRY_DELAY=1.0
CLICKHOUSE_RETRY_BACKOFF_MULTIPLIER=1.5

# Verbose logging for each trade (for debugging - very verbose)
CLICKHOUSE_VERBOSE_TRADE_LOGGING=false

# =============================================================================
# FEATURE FLAGS
# =============================================================================

# WebSocket streaming features
FEATURES_ENABLE_WEBSOCKET_STREAMING=true
FEATURES_ENABLE_PER_TICKER_WEBSOCKETS=true
FEATURES_WEBSOCKET_HISTORICAL_DATA=true

# ClickHouse features
FEATURES_ENABLE_MATERIALIZED_VIEWS=true
FEATURES_ENABLE_BUFFER_TABLES=true
FEATURES_ENABLE_COMPRESSION=true

# API features
FEATURES_ENABLE_REST_API=true
FEATURES_ENABLE_ADMIN_ENDPOINTS=true
FEATURES_ENABLE_METRICS_ENDPOINT=true

# Development features
FEATURES_ENABLE_DEBUG_LOGGING=false
FEATURES_ENABLE_QUERY_PROFILING=false
FEATURES_ENABLE_TEST_ENDPOINTS=false

# =============================================================================
# WEBSOCKET STREAMING CONFIGURATION
# =============================================================================

# Per-ticker WebSocket settings
WS_STREAMING_PER_TICKER_ENABLED=true
WS_STREAMING_MAX_CONNECTIONS_PER_TICKER=100
WS_STREAMING_CONNECTION_TIMEOUT=30
WS_STREAMING_PING_INTERVAL=30
WS_STREAMING_PING_TIMEOUT=10

# Historical data streaming
WS_STREAMING_HISTORICAL_DATA_ENABLED=true
WS_STREAMING_MAX_HISTORICAL_LIMIT=1000
WS_STREAMING_HISTORICAL_TIMEOUT=60

# Update broadcasting
WS_STREAMING_BROADCAST_INTERVAL_MS=100
WS_STREAMING_MAX_UPDATES_PER_BROADCAST=100
WS_STREAMING_ENABLE_COMPRESSION=true

# Subscription management
WS_STREAMING_MAX_SUBSCRIPTIONS_PER_CONNECTION=50
WS_STREAMING_SUBSCRIPTION_TIMEOUT=5

# Memory management
WS_STREAMING_CONNECTION_BUFFER_SIZE_MB=1
WS_STREAMING_MAX_TOTAL_MEMORY_MB=100

# =============================================================================
# BINANCE API CONFIGURATION
# =============================================================================

# Binance API credentials (REQUIRED - get from Binance account)
BINANCE_API_KEY=
BINANCE_SECRET_KEY=

# Rate limiting settings (Binance futures limits)
BINANCE_MAX_WEIGHT_PER_MINUTE=2400
BINANCE_WEIGHT_BUFFER=200
BINANCE_HISTORICAL_TRADES_WEIGHT=20
BINANCE_MAX_REQUESTS_PER_SECOND=10

# Request settings
BINANCE_REQUEST_TIMEOUT=30
BINANCE_MAX_RETRIES=5
BINANCE_RETRY_DELAY=1.0
BINANCE_BACKOFF_MULTIPLIER=2.0

# WebSocket settings
BINANCE_WS_PING_INTERVAL=20
BINANCE_WS_PONG_TIMEOUT=10
BINANCE_WS_CLOSE_TIMEOUT=10
BINANCE_WS_RECONNECT_DELAY=5
BINANCE_WS_MAX_RECONNECTS=10

# Library settings
BINANCE_USE_TESTNET=false
BINANCE_DEBUG_MODE=false

# =============================================================================
# DATA PROCESSING CONFIGURATION
# =============================================================================

# Historical data settings
PROCESSING_HISTORICAL_DAYS_BACK=360
PROCESSING_MERGE_THRESHOLD_HOURS=24

# Gap detection and recovery
PROCESSING_GAP_DETECTION_ENABLED=true
PROCESSING_AUTO_RECOVERY_ENABLED=true

# Batch processing
PROCESSING_BATCH_SIZE=1000

# Ticker processing (0 = all available tickers)
PROCESSING_CONCURRENT_TICKERS=0

# Development: Load only specific tickers (comma-separated)
# Examples:
# PROCESSING_LOAD_ONLY_TICKERS=BTCUSDT,ETHUSDT,ADAUSDT  # Load only these 3
# PROCESSING_LOAD_ONLY_TICKERS=BTCUSDT                   # Load only Bitcoin
# PROCESSING_LOAD_ONLY_TICKERS=
PROCESSING_LOAD_ONLY_TICKERS=BTCUSDT,POLUSDT

# Process management
PROCESSING_TICKER_TIMEOUT_MINUTES=30
PROCESSING_HEALTH_CHECK_INTERVAL=60
PROCESSING_RESTART_FAILED_PROCESSES=true

# Memory management
PROCESSING_MAX_MEMORY_USAGE_MB=1024
PROCESSING_MEMORY_CHECK_INTERVAL=300
PROCESSING_FORCE_GC_INTERVAL_MINUTES=15

# Data validation
PROCESSING_VALIDATE_TRADE_DATA=true
PROCESSING_SKIP_INVALID_TRADES=true
PROCESSING_MAX_INVALID_TRADES_PERCENT=5.0

# Error handling
PROCESSING_MAX_CONSECUTIVE_ERRORS=10
PROCESSING_ERROR_RECOVERY_DELAY=5
PROCESSING_BINANCE_ERROR_RETRY_MULTIPLIER=2.0

# Logging each trade (for debugging - very verbose)
VERBOSE_TRADE_LOGGING=false

# WebSocket coordination settings
# WebSocket Buffer Size Configuration:
# ------------------------------------
# This setting controls how many trades each WebSocket keeps in memory
# during buffering mode (before switching to streaming).
#
# Memory usage calculation:
# 600 tickers × BUFFER_SIZE × 80 bytes = Total RAM
#
# Examples:
# PROCESSING_WEBSOCKET_BUFFER_MAX_TRADES=500   # ~24MB total, 1.5s peak coverage
# PROCESSING_WEBSOCKET_BUFFER_MAX_TRADES=1000  # ~48MB total, 3s peak coverage
# PROCESSING_WEBSOCKET_BUFFER_MAX_TRADES=2000  # ~96MB total, 6s peak coverage
#
# Peak coverage is for BTCUSDT at 20,000 trades/minute
# Lower activity tickers will have much longer coverage
PROCESSING_WEBSOCKET_SWITCH_HOURS=24
PROCESSING_WEBSOCKET_BUFFER_MAX_TRADES=1000
PROCESSING_WEBSOCKET_BATCH_SIZE=100
PROCESSING_WEBSOCKET_FLUSH_INTERVAL=10
PROCESSING_MAX_WEBSOCKET_RECONNECTS=5

# =============================================================================
# DATABASE CONFIGURATION (MariaDB for ticker management)
# =============================================================================

# Database connection
DB_HOST=
DB_PORT=3306
DB_DATABASE=
DB_USERNAME=
DB_PASSWORD=

# Connection pool settings
DB_MIN_POOL_SIZE=5
DB_MAX_POOL_SIZE=20
DB_POOL_RECYCLE_SECONDS=3600
DB_POOL_TIMEOUT_SECONDS=30

# Query settings
DB_QUERY_TIMEOUT_SECONDS=30
DB_CHARSET=utf8mb4
DB_AUTOCOMMIT=true

# Ticker synchronization
DB_TICKER_SYNC_INTERVAL_HOURS=1
DB_TICKER_TABLE_NAME=ticker

# =============================================================================
# MONITORING CONFIGURATION (Loggerino)
# =============================================================================

# Loggerino logging settings
LOGGERINO_LEVEL=INFO
LOGGERINO_FORMAT=default
LOGGERINO_FILE_ENABLED=true
LOGGERINO_FILE_PATH=./logs/system.log
LOGGERINO_FILE_ROTATION=100 MB
LOGGERINO_FILE_RETENTION=30 days

# Prometheus metrics
MONITORING_METRICS_ENABLED=true
MONITORING_METRICS_PORT=9090
MONITORING_METRICS_HOST=0.0.0.0
MONITORING_METRICS_PATH=/metrics

# Health monitoring
MONITORING_HEALTH_CHECK_PORT=8080
MONITORING_HEALTH_CHECK_PATH=/health
MONITORING_SYSTEM_STATS_INTERVAL=60

# Alerting (basic webhook notifications)
MONITORING_ALERTS_ENABLED=false
MONITORING_ALERT_WEBHOOK_URL=
MONITORING_CRITICAL_ERROR_THRESHOLD=5
MONITORING_MEMORY_ALERT_THRESHOLD=85

# =============================================================================
# API CONFIGURATION
# =============================================================================

# REST API settings
API_REST_HOST=0.0.0.0
API_REST_PORT=8080
API_REST_WORKERS=4
API_REST_MAX_REQUEST_SIZE=16777216

# WebSocket API settings (increased for per-ticker architecture)
API_WEBSOCKET_PING_INTERVAL=30
API_WEBSOCKET_PING_TIMEOUT=10

# Rate limiting
API_ENABLE_RATE_LIMITING=true
API_RATE_LIMIT_RPM=1200
API_MAX_CONNECTIONS_PER_IP=10

# CORS settings
API_CORS_ENABLED=true
API_CORS_ORIGINS=*
API_CORS_METHODS=GET,POST

API_WEBSOCKET_ENABLED=true
API_WEBSOCKET_UPDATE_INTERVAL=1
API_WEBSOCKET_CONNECTION_TIMEOUT=300
API_WEBSOCKET_MAX_MESSAGE_SIZE=1048576
API_WEBSOCKET_PING_INTERVAL=30
API_WEBSOCKET_PING_TIMEOUT=10
API_WEBSOCKET_ENABLE_HEARTBEAT=true
API_WEBSOCKET_HEARTBEAT_INTERVAL=60

# =============================================================================
# TELEGRAM NOTIFICATIONS
# =============================================================================

# Enable/disable Telegram notifications
TELEGRAM_ENABLED=true

# Bot token from @BotFather
TELEGRAM_BOT_TOKEN=

# Chat/Group/Channel ID (use @userinfobot to get your ID)
TELEGRAM_CHAT_ID=

# Alert types
TELEGRAM_SEND_GAP_ALERTS=true
TELEGRAM_SEND_RECOVERY_ALERTS=true
TELEGRAM_SEND_TICKER_STOPPED_ALERTS=true

# =============================================================================
# EXAMPLE CONFIGURATIONS BY ENVIRONMENT
# =============================================================================

# Development Configuration Examples:
# -----------------------------------
# ENVIRONMENT=development
# DEBUG=true
# PROCESSING_LOAD_ONLY_TICKERS=BTCUSDT,ETHUSDT
# PROCESSING_HISTORICAL_DAYS_BACK=7
# CLICKHOUSE_TRADES_RETENTION_DAYS=30
# LOGGERINO_LEVEL=DEBUG
# FEATURES_ENABLE_DEBUG_LOGGING=true
# FEATURES_ENABLE_TEST_ENDPOINTS=true

# Production Configuration Examples:
# ----------------------------------
# ENVIRONMENT=production
# DEBUG=false
# PROCESSING_LOAD_ONLY_TICKERS=
# PROCESSING_HISTORICAL_DAYS_BACK=30
# CLICKHOUSE_TRADES_RETENTION_DAYS=365
# LOGGERINO_LEVEL=INFO
# MONITORING_ALERTS_ENABLED=true
# MONITORING_ALERT_WEBHOOK_URL=https://hooks.slack.com/your-webhook
# FEATURES_ENABLE_DEBUG_LOGGING=false
# FEATURES_ENABLE_TEST_ENDPOINTS=false

# High-Performance Configuration Examples:
# ----------------------------------------
# CLICKHOUSE_CONNECTION_POOL_SIZE=20
# CLICKHOUSE_MAX_CONNECTIONS_PER_HOST=50
# CLICKHOUSE_BUFFER_MAX_ROWS=2000000
# CLICKHOUSE_MAX_INSERT_BLOCK_SIZE=2097152
# CLICKHOUSE_MAX_THREADS=8
# WS_STREAMING_MAX_CONNECTIONS_PER_TICKER=200
# API_WEBSOCKET_MAX_CONNECTIONS=2000

# Docker Configuration Examples:
# ------------------------------
# CLICKHOUSE_HOST=clickhouse
# DB_HOST=mariadb
# MONITORING_METRICS_HOST=0.0.0.0

# =============================================================================
# CLICKHOUSE ARCHITECTURE NOTES
# =============================================================================

# Database Schema:
# ---------------
# 1. Main table: trades.trades_local (partitioned by month + symbol hash)
# 2. Buffer table: trades.trades_buffer (optimized inserts)
# 3. Materialized Views: trades.ohlcv_{timeframe}_{symbol}_mv (dynamic creation)

# Performance Optimization:
# ------------------------
# 1. Buffer tables handle high-frequency inserts (100K+ trades/second)
# 2. Materialized Views provide sub-100ms OHLCV queries
# 3. LZ4 compression reduces storage by 80%+
# 4. Partitioning enables efficient queries and TTL cleanup

# Per-Ticker WebSocket Architecture:
# ---------------------------------
# 1. One WebSocket endpoint per ticker: /ws/ticker/{symbol}
# 2. Selective timeframe subscriptions reduce bandwidth
# 3. Historical + real-time data in unified stream
# 4. Memory-efficient: ~45KB per connection vs 196MB for all-streams

# Migration from Binary Files:
# ----------------------------
# No migration needed - pure ClickHouse from start
# All existing BinaryFileManager references replaced with ClickHouseManager

# =============================================================================
# SECURITY NOTES
# =============================================================================

# 1. NEVER commit real API keys or passwords to version control
# 2. Use strong, unique passwords for ClickHouse and database connections
# 3. Restrict API key permissions to only required operations
# 4. Use environment-specific .env files for different deployments
# 5. Consider using secret management tools for production
# 6. Enable ClickHouse authentication for production deployments
# 7. Use SSL/TLS for ClickHouse connections in production

# =============================================================================
# SETUP INSTRUCTIONS
# =============================================================================

# 1. Install ClickHouse server:
#    - Ubuntu/Debian: sudo apt-get install clickhouse-server clickhouse-client
#    - Docker: docker run -d --name clickhouse-server --ulimit nofile=262144:262144 -p 8123:8123 -p 9000:9000 clickhouse/clickhouse-server
#
# 2. Create database and tables:
#    - Connect: clickhouse-client
#    - Run: CREATE DATABASE trades;
#    - Tables will be auto-created by ClickHouseManager
#
# 3. Copy this file: cp .env.example .env
# 4. Edit .env with your actual values
# 5. Install Python dependencies: pip install aiochclient
# 6. Ensure .env is in your .gitignore file
# 7. For production, use secure secret management instead of .env files

# =============================================================================
# PERFORMANCE EXPECTATIONS
# =============================================================================

# Write Performance: 100K+ trades/second via buffer tables
# Read Performance: <100ms for historical klines queries
# Storage Efficiency: 10:1+ compression with LZ4
# WebSocket Capacity: 600-700 concurrent connections
# Memory Usage: <50MB total for WebSocket connections
# Real-time Latency: <10ms from MV update to client notification